
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>è®ºè¿œç¨‹é›¶ä¿¡ä»»è®¿é—®çš„æ­å»º(1)Headscaleçš„æ­å»º | Cainong&#39;s Blog</title>
    <meta name="author" content="Cainong" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.png" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 5.4.2"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>åŠ è½½è¿‡æ…¢è¯·å¼€å¯ç¼“å­˜ æµè§ˆå™¨é»˜è®¤å¼€å¯</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>CAINONG&#39;S BLOG</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;CAINONG&#39;S BLOG</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>è®ºè¿œç¨‹é›¶ä¿¡ä»»è®¿é—®çš„æ­å»º(1)Headscaleçš„æ­å»º</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/11/1
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/HomeLab/" style="color: #03a9f4">
                    HomeLab
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/WireGuard/" style="color: #00a596">
                    WireGuard
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/%E8%99%9A%E6%8B%9F%E7%BD%91%E8%B7%AF/" style="color: #00bcd4">
                    è™šæ‹Ÿç½‘è·¯
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨è¿ç§»AquaDXåˆ°K8sé›†ç¾¤ä¸­çš„æ—¶å€™ï¼Œæˆ‘éœ€è¦ç»™åˆ«äººè¿œç¨‹è®¿é—®çš„æƒé™</p>
<p>æˆ‘çš„æœåŠ¡å™¨æ˜¯ä¸å…¬å¼€çš„ æˆ‘å¹¶ä¸æ‰“ç®—å…¬å¼€å‡ºå»ç»™æ‰€æœ‰äººç”¨</p>
<p>ä¹‹å‰ç”¨çš„ZeroTierå› ä¸ºå‡ ä¸ªåŸå› æˆ‘å†³å®šåºŸå¼ƒäº†ï¼š</p>
<ul>
<li>ä»–æŠŠè·¯ç”±é€‰é¡¹ä»æ§åˆ¶é¢æ¿ä¸­åˆ é™¤äº†ï¼Œæ”¹ä¸ºè¦ä»˜è´¹çš„</li>
<li>ä»–è¦ä¿®æ”¹å®¿ä¸»æœºçš„tuné…ç½®æ¥å®ç°äºŒå±‚ä¸Šçš„ç½‘ç»œä»£ç†ï¼Œè¿™åœ¨K8sä¸­æ˜¯ä¸å…è®¸çš„</li>
<li>æ‰“æ´ç­–ç•¥å¤ªè¿· å³ä½¿èƒ½UPnPç›´è¿æˆ–è€…IPv6ç›´è¿æœ‰æ—¶å€™ä»–è¿˜æ˜¯ä¸­è½¬</li>
</ul>
<span id="more"></span> 

<p>ç¬¬ä¸€ç‚¹å¯¼è‡´æˆ‘æ²¡æ³•ç”¨æ¥ä»£ç†æ•´ä¸ªç½‘æ®µäº†ï¼Œä»¥å‰æˆ‘æŠŠä»–è£…åœ¨OpenWrtä¸Šï¼Œè¿™æ ·æˆ‘å¯ä»¥è¿æ¥ä¸Šç½‘ç»œä¹‹åè®¿é—®æˆ‘æ•´ä¸ªå±€åŸŸç½‘ï¼Œç°åœ¨æ²¡äº†</p>
<p>ç¬¬äºŒç‚¹åˆ™æ˜¯ä»–çš„ç¡¬ä¼¤ï¼Œæˆ–è®¸æˆ‘ä»¬æœ‰æ–¹æ³•è®©ä»–ä¸ä¿®æ”¹tunï¼Œä½†æ˜¾ç„¶æ²¡å¿…è¦</p>
<p>æˆ‘ä»¬å¯ä»¥é€‰æ‹©æ€§èƒ½æ›´é«˜çš„ä¸‰å±‚ç½‘ç»œæ–¹æ¡ˆï¼ŒåŸºäºWireGuardçš„ä¸€å¤§å †éƒ½å¯ä»¥</p>
<p>æˆ‘çœ‹åˆ°äº†Githubä¸Šçš„è¿™ä¸ªï¼š<a target="_blank" rel="noopener" href="https://github.com/HarvsG/WireGuardMeshes/blob/main/readme.md">https://github.com/HarvsG/WireGuardMeshes/blob/main/readme.md</a></p>
<p><img src="https://s2.loli.net/2025/11/01/5eDEgbcFzxdIstW.png" alt="Code_qMmZJDTt8C.png"></p>
<p>å¯ä»¥çœ‹åˆ°æœ€æˆç†Ÿçš„åº”è¯¥æ˜¯NetBirdå’ŒTailscale</p>
<p>æˆ‘åœ¨ä¹‹å‰æ˜¯ä½¿ç”¨è¿‡Tailscaleçš„ï¼Œä¹Ÿç¡®å®å¾ˆæˆç†Ÿ</p>
<p>NetBirdä¹Ÿä¸å·®</p>
<p>è€ƒè™‘åˆ°æˆ‘ç”¨è¿‡Tailscaleï¼Œæˆ‘å†³å®šè¿˜æ˜¯ç”¨ä»–</p>
<p>ä½†æ˜¯Tailscaleæ‰“æ´ä¸­è½¬å»¶è¿Ÿéå¸¸é«˜ï¼Œå› ä¸ºå›½å†…æ²¡æœ‰æœåŠ¡å™¨</p>
<p>é‚£ä¹ˆæœ‰æ²¡æœ‰æœ€å¤¯çš„æ–¹å¼å‘¢</p>
<h1 id="è‡ªå»ºHeadscale"><a href="#è‡ªå»ºHeadscale" class="headerlink" title="è‡ªå»ºHeadscale"></a>è‡ªå»ºHeadscale</h1><p>æˆ‘å…¶å®æƒ³è¿‡è‡ªå»ºNetbirdï¼Œä½†æˆ‘ä¸€æ‰“å¼€Netbirdé‚£ç½‘ç«™å’ŒTailscaleä¹Ÿå·®ä¸å¤šå˜›</p>
<p>ä¸Šé¢é‚£ä¸ªå›¾çš„HeadScaleå…¶å®å°±æ˜¯Tailscaleæ§åˆ¶å¹³é¢çš„å¼€æºå®ç°</p>
<p>TailScaleå®¢æˆ·ç«¯æ˜¯å¼€æºçš„ï¼Œæ§åˆ¶ç«¯åˆ™é—­æº å’ŒZerotierä¸€æ ·</p>
<p>äº‹å®ä¸Šçš„è¯æˆ‘ä»¬å¯ä»¥è‡ªå·±æ­å»ºä¸­ç»§èŠ‚ç‚¹ï¼Œç„¶åç”¨Tailscaleå®˜æ–¹çš„åŠŸèƒ½å°±å®Œå…¨è¶³å¤Ÿäº†</p>
<p>ä½†æ˜¯éƒ½è¦è‡ªå·±æ­äº†æˆ‘å¹²å˜›ä¸æŠŠæ§åˆ¶å¹³é¢ä¹Ÿè‡ªå·±å¼„äº†å‘¢ï¼ˆï¼‰é¡ºä¾¿è§£é”ä¸€äº›æ”¶è´¹æ‰èƒ½ç”¨çš„åŠŸèƒ½</p>
<p>ä¹Ÿèƒ½åŒæ—¶è§£å†³æ‰“ä¸äº†æ´éš¾ä¸­è½¬çš„é—®é¢˜</p>
<p>å…¶å®çš„è¯ä¸éš¾ï¼ŒHeadscaleéº»çƒ¦çš„æ˜¯é‚£ä¸ªconfig</p>
<pre><code class="YAML">---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations: &#123;&#125;
  labels:
    app: headscale
    k8s.kuboard.cn/name: headscale
  name: headscale
  namespace: headscale
spec:
  replicas: 1
  selector:
    matchLabels:
      app: headscale
      labels:
        app: headscale
    spec:
      containers:
        - command:
            - headscale
            - serve
          image: &#39;docker.io/headscale/headscale:stable&#39;
          imagePullPolicy: IfNotPresent
          name: headscale
          ports:
            - containerPort: 8080
              name: web
              protocol: TCP
            - containerPort: 9090
              name: metrics
              protocol: TCP
            - containerPort: 50443
              name: grpc
              protocol: TCP
          volumeMounts:
            - mountPath: /var/lib/headscale
              name: headscale-data
            - mountPath: /var/run/headscale
              name: headscale-data
            - mountPath: /etc/headscale
              name: config
              readOnly: true
      volumes:
        - name: headscale-data
          persistentVolumeClaim:
            claimName: headscale-data
        - configMap:
            defaultMode: 420
            items:
              - key: server-config.yaml
                path: config.yml
            name: server-config.yaml
          name: config
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    metallb.io/ip-allocated-from-pool: default-address-pool
  labels:
    app: headscale
    k8s.kuboard.cn/name: headscale
  name: headscale
  namespace: headscale
spec:
  allocateLoadBalancerNodePorts: true
  clusterIP: 10.110.187.183
  clusterIPs:
    - 10.110.187.183
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  ipFamilies:
    - IPv4
  ipFamilyPolicy: SingleStack
  ports:
    - name: web
      nodePort: 30667
      port: 8080
      protocol: TCP
      targetPort: 8080
    - name: metrics
      nodePort: 32383
      port: 9090
      protocol: TCP
      targetPort: 9090
    - name: grpc
      nodePort: 32594
      port: 50443
      protocol: TCP
      targetPort: 50443
  selector:
    app: headscale
  sessionAffinity: None
  type: LoadBalancer
status:
  loadBalancer:
    ingress:
      - ip: 10.0.100.11
        ipMode: VIP
</code></pre>
<p>ç„¶åçš„è¯æ˜¯config</p>
<pre><code class="YAML">server_url: http://127.0.0.1:8080

listen_addr: 0.0.0.0:8080
metrics_listen_addr: 0.0.0.0:9090
grpc_listen_addr: 0.0.0.0:50443
grpc_allow_insecure: true

noise:
  private_key_path: /var/lib/headscale/noise_private.key

prefixes:
  v4: 100.64.0.0/10
  v6: fd7a:115c:a1e0::/48
  allocation: sequential

derp:
  server:
    enabled: false
  urls:
    - https://controlplane.tailscale.com/derpmap/default
  auto_update_enabled: true
  update_frequency: 3h

disable_check_updates: false
ephemeral_node_inactivity_timeout: 30m

database:
  type: sqlite
  sqlite:
    path: /var/lib/headscale/db.sqlite
    write_ahead_log: true
    wal_autocheckpoint: 1000

acme_url: https://acme-v02.api.letsencrypt.org/directory
tls_letsencrypt_cache_dir: /var/lib/headscale/cache
tls_cert_path: &quot;&quot;
tls_key_path: &quot;&quot;

log:
  level: info
  format: text

policy:
  mode: file
  path: &quot;&quot;

dns:
  magic_dns: true
  base_domain: headscale.lan
  override_local_dns: true
  nameservers:
    global:
      - 1.1.1.1
      - 8.8.8.8
  split: &#123;&#125;
  search_domains: []
  extra_records: []

unix_socket: /var/run/headscale/headscale.sock
unix_socket_permission: &quot;0770&quot;

logtail:
  enabled: false

randomize_client_port: false
</code></pre>
<p>ä¸å‡ºæ„å¤–å°±æ²¡é—®é¢˜äº†ï¼Œä½†æ˜¯Headscaleæ²¡æœ‰GUIï¼Œæ­èµ·æ¥ä¹‹åæˆ‘ä»¬å¾—ç”¨CLIè®¿é—®</p>
<p>è¿™è¡Œå— è¿™è‚¯å®šä¸è¡Œå•Š</p>
<p>æˆ‘ä»¬å¯ä»¥å‚è€ƒHeadscaleçš„å®˜æ–¹ç•Œé¢é€‰ä¸€ä¸ªGUI</p>
<p><a target="_blank" rel="noopener" href="https://headscale.net/stable/ref/integration/web-ui/">https://headscale.net/stable/ref/integration/web-ui/</a></p>
<p>æˆ‘é€‰äº†ä¸€ä¸‹æœ‰å››ä¸ª</p>
<p><a target="_blank" rel="noopener" href="https://github.com/simcu/headscale-ui">https://github.com/simcu/headscale-ui</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/tale/headplane">https://github.com/tale/headplane</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/GoodiesHQ/headscale-admin">https://github.com/GoodiesHQ/headscale-admin</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/rickli-cloud/headscale-console">https://github.com/rickli-cloud/headscale-console</a></p>
<p>æ ¹æ®è‡ªå·±å¯¹UIçš„å–œå¥½é€‰ä¸€ä¸ªå°±å¥½</p>
<p>æœ€åæˆ‘æ ¹æ®Staræ•°å’Œæ›´æ–°é¢‘ç‡å†³å®šé€‰æ‹©headplane</p>
<p>ä»–çš„UIä¹Ÿæ˜¯ä»¿é€ çš„Tailscale <del>æŠŠäººé¥­ç¢—æŠ¢å…‰å…‰äº†</del></p>
<p>ä¹Ÿå¥½ï¼Œç†Ÿæ‚‰Tailscaleå¯ä»¥ç›´æ¥ä¸Šæ‰‹</p>
<p>å»çœ‹ä¸€ä¸‹è¿™ç©æ„è¿˜æ”¯æŒåä»£,SSO,SSH key å®Œç¾</p>
<p>çœ‹äº†ä¸€ä¸‹ä¸ºäº†Headplaneèƒ½ç®¡ç†ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯æŠŠä»–ä»¬è·‘åœ¨ä¸€èµ·</p>
<p>æˆ‘ä¸€å¼€å§‹æƒ³çš„æ˜¯ç»™ä»–ä»¬æŒ‚åœ¨åŒä¸€ä¸ªDeploymentä¸‹ ä½¿ç”¨ä¸¤ä¸ªå·¥ä½œå®¹å™¨</p>
<p>å…¶å®æ²¡å¿…è¦ï¼Œåˆ†å¼€ä¹Ÿæ˜¯å®Œå…¨å¯ä»¥çš„</p>
<p><del>å› ä¸ºæˆ‘æŠŠheadscaleå’Œheadplaneçœ‹æ··å¥½å‡ æ¬¡</del></p>
<p>è¿™ä»–å¦ˆä¹Ÿå¤ªåƒäº†å§</p>
<p>ä¸ºäº†ä¾¿äºåŒºåˆ†ï¼Œä¹‹åHeadscaleç®€ç§°Scaleï¼ŒHeadplaneç®€ç§°Plane</p>
<p><img src="https://s2.loli.net/2025/11/02/IvdpfYiELzsVhBG.png" alt="chrome_HxIF1PpUZy.png"></p>
<p>ä¸ç®¡æ€ä¹ˆè¯´ï¼Œæˆ‘ä»¬å…ˆæŠŠä»–<del>åˆ†å¼€éƒ¨ç½²</del></p>
<p>è¯·æŠŠPlaneå’ŒScaleæ”¾åœ¨åŒä¸€ä¸ªDeploymentä¸­ï¼Œè¯¦æƒ…çœ‹åé¢å°±çŸ¥é“äº†ğŸ˜„</p>
<pre><code class="YAML">---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    k8s.kuboard.cn/name: plane
  name: plane
  namespace: headscale
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      k8s.kuboard.cn/name: plane
  template:
    metadata:
      labels:
        k8s.kuboard.cn/name: plane
    spec:
      containers:
        - image: &#39;ghcr.io/tale/headplane:latest&#39;
          imagePullPolicy: IfNotPresent
          name: headplane
          ports:
            - containerPort: 3000
              name: web
              protocol: TCP
          volumeMounts:
            - mountPath: /etc/headplane
              name: config
            - mountPath: /var/lib/headplane
              name: data
            - mountPath: /etc/headscale
              name: scale-config
              readOnly: true
      volumes:
        - configMap:
            items:
              - key: config.yml
                path: config.yaml
            name: plane-config
          name: config
        - name: data
          persistentVolumeClaim:
            claimName: headplane-data
        - configMap:
            items:
              - key: server-config.yaml
                path: config.yaml
            name: server-config.yaml
          name: scale-config

---
apiVersion: v1
kind: Service
metadata:
  annotations: &#123;&#125;
  labels:
    k8s.kuboard.cn/name: plane
  name: plane
  namespace: headscale
  ports:
    - name: web
      port: 3000
      protocol: TCP
      targetPort: 3000
  selector:
    k8s.kuboard.cn/name: plane
  sessionAffinity: None
  type: ClusterIP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations: &#123;&#125;
  labels:
    k8s.kuboard.cn/name: plane
  name: plane
  namespace: headscale
spec:
  ingressClassName: nginx-ingress
  rules:
    - host: headplane.k8s.lan
      http:
        paths:
          - backend:
              service:
                name: plane
                port:
                  number: 3000
            path: /
            pathType: Prefix
</code></pre>
<p>ç„¶åè¿˜æœ‰Config</p>
<pre><code class="YAML">    server:
      host: &quot;0.0.0.0&quot;
      port: 3000
      cookie_secret: &quot;$(openssl rand -hex 16)ä¸€ä¸ªåœ¨è¿™é‡Œ&quot;
      cookie_secure: false # ä¸æ”¹çš„è¯ä¸æ˜¯httpsä¸ä¼šå‘é€Cookie
      data_path: &quot;/var/lib/headplane&quot;
    headscale:
      url: &quot;http://headscale.headscale.svc.cluster.local&quot;
      config_path: &quot;/etc/headscale/config.yaml&quot;
      config_strict: true
    integration:
      agent:
        enabled: false
        pre_authkey: &quot;&lt;your-preauth-key&gt;&quot;
      docker:
        enabled: false
        container_label: &quot;me.tale.headplane.target=headscale&quot;
        socket: &quot;unix:///var/run/docker.sock&quot;
      kubernetes:
        enabled: true
        validate_manifest: true
        pod_name: &quot;headscale&quot;

      proc:
        enabled: false
</code></pre>
<p>æˆ‘è¿™é‡ŒæŠŠOIDCæ®µåˆ äº†ï¼Œæˆ‘ä»¬å…ˆè·‘èµ·æ¥å†å»é…ç½®</p>
<p>ç„¶åå°±æŠ¥é”™äº†</p>
<p><img src="https://s2.loli.net/2025/11/02/LOFCWGRD5E4Mr3X.png" alt="chrome_o0shplXi5G.png"></p>
<p>å‚»é€¼äº† å› ä¸ºæˆ‘ä»¬è®¾ç½®äº†kubernetes integration</p>
<p>ç®€å•æ¥è¯´å°±æ˜¯å¯ä»¥è®©Planeè‡ªåŠ¨å‘ç°é›†ç¾¤ä¸­çš„ScaleæœåŠ¡ï¼Œè‡ªåŠ¨é€šä¿¡</p>
<p>æˆ‘ä»¬ç°åœ¨éœ€è¦è®¾ç½®ä¸€ä¸‹Service Accountï¼Œé»˜è®¤çš„defaultæ˜¯æ²¡æœ‰ä»»ä½•æƒé™çš„</p>
<p>æˆ‘ä»¬éœ€è¦è®©planeå¯ä»¥æŸ¥çœ‹è®¿é—®åŒå‘½åç©ºé—´ä¸‹çš„pod</p>
<pre><code class="YAML">---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: headplane
  namespace: headscale

---

apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: headplane-role
  namespace: headscale
rules:
  - apiGroups: [&quot;&quot;]
    resources: [&quot;pods&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: headplane-role
  namespace: headscale
rules:
  - apiGroups: [&quot;&quot;]
    resources: [&quot;pods&quot;]
    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
</code></pre>
<p>ç„¶åä¿®æ”¹ä¸€ä¸‹Planeè®©ä»–ä½¿ç”¨è¿™ä¸ªServiceAccount</p>
<p><img src="https://s2.loli.net/2025/11/02/O4QmLHWnUSVN5r1.png" alt="chrome_yEXT2ASdGI.png"></p>
<p>é‡å¯ä¸€ä¸‹</p>
<p><img src="https://s2.loli.net/2025/11/02/sw7lI4WQEbSxBXf.png" alt="chrome_aWvroyqhBG.png"></p>
<p>å°¼ç›ã€‚</p>
<p><img src="https://s2.loli.net/2025/11/02/jlIXZLkwfWeuyO9.png" alt="chrome_7tRqUk9g66.png"></p>
<p>æˆ‘æƒ³åˆ°Podåå­—æ˜¯éšæœºçš„ï¼Œæˆ‘ä»¬åœ¨Configé‡Œå¡«çš„</p>
<pre><code class="YAML">kubernetes:
        enabled: true
        validate_manifest: true
        pod_name: &quot;headscale&quot;
</code></pre>
<p>ä»–å…¶å®è¿˜æœ‰ä¸€è¡Œæ³¨é‡Šåœ¨ä¸Šé¢ï¼š</p>
<pre><code class="YAML">kubernetes:
        enabled: true
        validate_manifest: true
    # This should be the name of the Pod running Headscale and Headplane.
    # If this isn&#39;t static you should be using the Kubernetes Downward API
    # to set this value (refer to docs/Integrated-Mode.md for more info).
        pod_name: &quot;headscale&quot;
</code></pre>
<p>æˆ‘å»çœ‹çœ‹ä»–çš„æ–‡æ¡£å…ˆï¼š</p>
<p><img src="https://s2.loli.net/2025/11/02/Qm4SBUtG5A6aElN.png" alt="chrome_cVrkDNWzro.png"></p>
<p><img src="https://s2.loli.net/2025/11/02/ItpQnLYlAgoXh8P.png" alt="chrome_4tnEd6YmDo.png"></p>
<p><img src="https://s2.loli.net/2025/11/02/srluU2JYx1FH9iK.png" alt="chrome_aOqefgYEOX.png"></p>
<p>ï¼Ÿä½ è¿™ä¸ªæ–‡æ¡£åœ¨å“ªå‘¢</p>
<p>åæ­£è¯´ç™½äº†å°±æ˜¯ï¼ŒPodåå­—æ˜¯ä¼šå˜åŠ¨çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Downward APIå»è§£å†³è¿™ä¸ªé—®é¢˜</p>
<p>ç­‰ä¸€ä¸‹ å¸­å·´äº† é€šè¿‡è¿™ä¸ªæ³¨å…¥podnameéœ€è¦åŒä¸€ä¸ªDeployment</p>
<p><img src="https://s2.loli.net/2025/11/02/F6d7mjWso1eLrOP.png" alt="chrome_bdyAWlASSu.png"></p>
<p>æˆ‘çœŸæ˜¯è‰äº†</p>
<p>å…¶å®ä¹Ÿä¸ç”¨è¯´éå¾—æ³¨å…¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠScaleæ”¹æˆStatefulSetï¼Œè¿™æ ·ä»–çš„åå­—å°±æ˜¯å›ºå®šçš„äº†</p>
<p>å…¶å®çš„è¯integrationæ˜¯å¯ä»¥falseçš„ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢å·²ç»é€šè¿‡é›†ç¾¤å†…åŸŸåå®ç°Planeå¯¹Scaleçš„è®¿é—®äº†</p>
<p>ä½†æˆ‘å·²ç»æŠ˜è…¾åˆ°è¿™äº† ç»™ä»–ä¸€èµ·é…ä¸Šå§</p>
<p>æŠŠPlaneä¹Ÿæ”¾åˆ°åŒä¸€ä¸ªDeploymenté‡Œä½œä¸ºå¦ä¸€ä¸ªå·¥ä½œå®¹å™¨</p>
<p>ç­‰ä¸€ä¸‹å•Š configmapæ˜¯åªè¯»çš„</p>
<p>é‚£æ€ä¹ˆè®©Planeä¿®æ”¹config</p>
<p><img src="https://s2.loli.net/2025/11/02/jlIXZLkwfWeuyO9.png" alt="chrome_7tRqUk9g66.png"></p>
<p>æˆ‘çœŸçº¢äº† æˆ‘å†™åˆ°è¿™å·²ç»è¾¹æŠ˜è…¾è¾¹å†™3å°æ—¶äº† ç›´æ¥ç”¨Tailscaleçš„è¯Sidecaréƒ½è·‘èµ·æ¥æ”¶å·¥äº†</p>
<p>å§æ§½æˆ‘ä»¬è·‘èµ·æ¥è¿˜è¦è·‘Sidecarå‘¢</p>
<p><img src="https://s2.loli.net/2025/11/02/nd6xJpajgDCeQLB.png" alt="chrome_f2YiWJ9496.png"></p>
<p>æ²¡è¯è¯´äº† æŠ˜è…¾åˆ°è¿™æˆ‘å·²ç»æœ‰ç‚¹æ²‰é»˜äº† æˆ‘ä»¬å…ˆä¸ç®¡integration å…ˆçœ‹çœ‹èƒ½ä¸èƒ½ç”¨</p>
<p><img src="https://s2.loli.net/2025/11/02/rvkwf62smRMuxLI.png" alt="chrome_VmyRTHeNjl.png"></p>
<p><img src="https://s2.loli.net/2025/11/02/MF8d1VW3wfZGzXh.png" alt="chrome_0ezfV0GyRt.png"></p>
<p>æ¬¸ç­‰ä¸€ä¸‹</p>
<p>ç»™è‡ªå·±æŠ˜è…¾å‚»äº†ï¼ŒPlaneçš„é»˜è®¤ç•Œé¢æ˜¯/admin</p>
<p><img src="https://s2.loli.net/2025/11/02/yB6qmjIJ3TQPOYV.png" alt="chrome_W6NFyj0mmt.png"></p>
<p>ç™½æµªè´¹ä¸€ä¸ªå°æ—¶å»æ¥å›è°ƒï¼Œå…ˆç”¨Serviceè®¿é—®ä¸é¦™å—ï¼ˆ</p>
<p>é‚£æˆ‘ä»¬è¿›headscaleå®¹å™¨ç”Ÿæˆä¸€ä¸ªkeyå…ˆ</p>
<p>è¿™headscaleå®¹æ˜“é»˜è®¤å•¥shelléƒ½æ²¡æœ‰</p>
<p>æˆ‘ä»¬è¿˜å¾—å»masterèŠ‚ç‚¹execä¸€ä¸‹</p>
<p><img src="https://s2.loli.net/2025/11/02/iGLxQljmndTeZWC.png" alt="MobaXterm_HhxL4xJ142.png"></p>
<p>å¿˜è®°æŒ‡å®šå‘½åç©ºé—´äº† çœŸç©å‚»äº†</p>
<pre><code class="Bash">kubectl exec -n headscale -it headscale-59bd5c7d65-8j5k6 -- headscale apikeys create
</code></pre>
<p>ç„¶åå°±å¯ä»¥è¿›åˆ°ç®¡ç†ç•Œé¢äº†</p>
<p>é‚£å°±å‰©ä¸€ä¸ªå°é—®é¢˜</p>
<p><img src="https://s2.loli.net/2025/11/02/X4Qzqh2LCbvop9M.png" alt="chrome_D5PlYdJGjl.png"></p>
<p>æˆ‘ä»¬å¾—æŠŠConfigmapæ‹·è´åˆ°PVCä¸­å¹¶å…è®¸å¤šèŠ‚ç‚¹åŒæ—¶è¯»å†™</p>
<p>æˆ‘é€‰æ‹©ç”¨ä¸€ä¸ªinit podè‡ªåŠ¨æ‹·è´ï¼Œè¿™æ ·å°±èƒ½è§£å†³é—®é¢˜äº†</p>
<p><img src="https://s2.loli.net/2025/11/02/1Z48ud2ktQwjlas.png" alt="chrome_tK9Qo4sPEJ.png"></p>
<p><img src="https://s2.loli.net/2025/11/02/KOW3iGhZdHwfmcR.png" alt="chrome_hO3RyeKrJP.png"></p>
<p>ç„¶åå°±åœ¨è¿™æ—¶å€™</p>
<p><img src="https://s2.loli.net/2025/11/02/GORbTtVIuZsz6vU.png" alt="MobaXterm_Uma9Js4Akw.png"></p>
<p><img src="https://s2.loli.net/2025/11/02/LJ5Gc7TuWYeOq2s.png" alt="Lens_H0cPn9el6f.png"></p>
<p>å§æ§½Workerç‚¸äº†</p>
<p>çœŸæ˜¯åååˆå·å·å•Š</p>
<p>æˆ‘ä¸€çœ‹ æ™®ç½—ç±³ä¿®æ–¯åœ¨æˆ‘çš„Workeré‡Œç»™äººç±»å·å–ç«ç§å»äº†</p>
<p><img src="https://s2.loli.net/2025/11/02/zL5nGkWvi7fmNJc.png" alt="MobaXterm_yXuv6WzAlj.png"></p>
<p>è¥¿å·´äº†æä¸ªwgç»„ç½‘æä¸€æ™šä¸Š</p>
<p>æˆ‘å…ˆæŠŠGrafanaç›‘æ§å¥—ä»¶å…¨åˆ äº†</p>
<p>è¿™ä¸ªæ˜¯é¢˜å¤–è¯ ä¿®å¥½ä¹‹åå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨headplaneäº†</p>
<p><img src="https://s2.loli.net/2025/11/02/LGckObRigW4qXym.png" alt="chrome_h8OGPj5A47.png"></p>
<p>å†™äº†500å¤šè¡Œäº† ç»ˆäºå®Œäº‹äº†</p>
<p>é‚£æˆ‘ä»¬å°±é¡ºä¾¿é…ç½®ä¸‹OIDCå§</p>
<p>åªéœ€è¦åœ¨Planeçš„ä¸‹é¢åŠ ä¸Šè¿™äº›å°±å¥½äº†</p>
<p>ScaleåŒç†ï¼Œè¿™æ ·çš„è¯ç™»å½•çš„æ—¶å€™å°±ä¸ç”¨å»æ‰‹åŠ¨è¾“å…¥Machine keyï¼Œè¿‡OIDCå°±å¥½äº†</p>
<pre><code class="YAML">oidc:
  issuer: &quot;https://example.com/application/o/headplane-oidc/&quot;
  client_id: &quot;secret&quot;
  client_secret: &quot;secret&quot;
  scope: &quot;openid email profile&quot;
  disable_api_key_login: true
  token_endpoint_auth_method: &quot;client_secret_post&quot;
  headscale_api_key: &quot;api key&quot;
  redirect_uri: &quot;https://example.com/admin/oidc/callback&quot;
</code></pre>
<p>Authentikä¸Šçš„è¯ï¼Œåˆ«çš„éƒ½å’Œæ­£å¸¸åˆ›å»ºOIDCä¸€æ ·ï¼Œæœ€å…³é”®çš„æ˜¯è¦é€‰æ‹©ä¸€ä¸ªç­¾åè¯ä¹¦ï¼Œå¹¶ä¸”æ˜¯RS256åŠ å¯†çš„</p>
<p><img src="https://s2.loli.net/2025/11/04/c8r3AX92VWoQUS1.png" alt="chrome_4vfiXv3hhx.png"></p>
<p>è¿™æ ·çš„è¯å°±å¯ä»¥å®ç°åŠ å…¥ç½‘ç»œå’Œç®¡ç†éƒ½ç”¨åŒä¸€å¥—å¸å·äº†</p>
<p>å®Œäº‹ æ¥ä¸‹æ¥æ˜¯Sidecar å¤ªé•¿äº†æˆ‘å†³å®šæ”¾åˆ°å¦ä¸€ç¯‡</p>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            221 - 2025 Cainong&#39;s Blog
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Cainong
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
